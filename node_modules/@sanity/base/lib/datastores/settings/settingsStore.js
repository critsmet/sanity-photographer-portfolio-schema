"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

var _resolve = require("./backends/resolve");

const storageBackend = (0, _resolve.resolveBackend)();
const set$ = new _rxjs.Subject();

const prefixNamespace = (ns, key) => `${ns}::${key}`;

const updates$ = set$.pipe((0, _operators.switchMap)(event => storageBackend.set(event.key, event.value).pipe((0, _operators.map)(nextValue => ({
  key: event.key,
  value: nextValue
})))));

const _listen = (key, defValue) => {
  return (0, _rxjs.merge)(storageBackend.get(key, defValue), updates$.pipe((0, _operators.filter)(update => update.key === key), (0, _operators.map)(update => update.value)));
};

const _set = (key, value) => {
  set$.next({
    key,
    value
  });
};

const _forNamespace = ns => {
  return {
    forKey: key => {
      const namespacedKey = prefixNamespace(ns, key);
      return {
        listen: defaultValue => _listen(namespacedKey, defaultValue),
        set: value => _set(namespacedKey, value),
        del: () => _set(namespacedKey, undefined)
      };
    },
    listen: (key, defaultValue) => _listen(prefixNamespace(ns, key), defaultValue),
    set: (key, value) => _set(prefixNamespace(ns, key), value),
    del: key => _set(prefixNamespace(ns, key), undefined),
    forNamespace: sub => _forNamespace(prefixNamespace(ns, sub))
  };
};

var _default = {
  forNamespace: _forNamespace
};
exports.default = _default;